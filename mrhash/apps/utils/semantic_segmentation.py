import numpy as np
import pickle
from utils.labels import kitti_360_labels

instanceColors = np.array(
    (
        (0, 255, 0),
        (255, 0, 255),
        (0, 127, 255),
        (255, 127, 0),
        (127, 191, 127),
        (79, 6, 168),
        (185, 6, 5),
        (253, 254, 69),
        (55, 125, 6),
        (0, 255, 255),
        (221, 127, 250),
        (0, 255, 127),
        (0, 127, 127),
        (186, 80, 110),
        (127, 221, 250),
        (151, 247, 4),
        (112, 89, 214),
        (242, 163, 132),
        (0, 0, 255),
        (255, 0, 127),
        (54, 49, 78),
        (145, 3, 252),
        (155, 159, 25),
        (42, 184, 67),
        (42, 182, 180),
        (188, 244, 157),
        (6, 61, 184),
        (163, 78, 5),
        (149, 13, 94),
        (218, 59, 202),
        (101, 120, 93),
        (80, 249, 65),
        (141, 157, 207),
        (253, 48, 34),
        (95, 4, 20),
        (0, 0, 127),
        (83, 245, 170),
        (188, 206, 76),
        (205, 193, 235),
        (244, 209, 1),
        (51, 53, 250),
        (86, 197, 2),
        (12, 65, 4),
        (246, 112, 174),
        (123, 61, 147),
        (36, 197, 252),
        (181, 136, 139),
        (36, 122, 191),
        (251, 106, 81),
        (191, 3, 176),
        (94, 69, 20),
        (13, 130, 63),
        (255, 0, 0),
        (253, 226, 146),
        (188, 245, 250),
        (7, 181, 4),
        (73, 152, 234),
        (251, 56, 116),
        (142, 244, 102),
        (192, 125, 64),
        (9, 243, 190),
        (67, 90, 146),
        (190, 189, 162),
        (14, 6, 65),
        (11, 235, 57),
        (132, 76, 75),
        (179, 104, 201),
        (207, 9, 73),
        (124, 198, 57),
        (171, 49, 242),
        (8, 200, 123),
        (245, 159, 59),
        (104, 142, 154),
        (81, 5, 103),
        (127, 127, 255),
        (4, 3, 195),
        (242, 162, 201),
        (138, 212, 182),
        (120, 114, 31),
        (63, 246, 238),
        (104, 39, 218),
        (13, 68, 124),
        (229, 85, 0),
        (67, 3, 240),
        (69, 175, 130),
        (144, 36, 38),
        (252, 214, 214),
        (90, 246, 6),
        (175, 203, 2),
        (247, 84, 246),
        (207, 254, 27),
        (245, 207, 77),
        (61, 251, 119),
        (62, 96, 60),
        (86, 157, 48),
        (3, 75, 65),
        (253, 23, 186),
        (181, 43, 146),
        (255, 255, 0),
        (55, 102, 251),
        (197, 52, 41),
        (136, 15, 169),
        (214, 159, 2),
        (200, 8, 252),
        (7, 89, 222),
        (174, 153, 253),
        (147, 147, 84),
        (73, 40, 132),
        (3, 108, 21),
        (97, 192, 212),
        (201, 168, 101),
        (180, 122, 2),
        (0, 39, 231),
        (1, 163, 218),
        (204, 248, 84),
        (142, 106, 128),
        (53, 40, 24),
        (69, 211, 103),
        (195, 150, 192),
        (65, 52, 182),
        (103, 34, 70),
        (163, 91, 251),
        (63, 127, 127),
        (133, 253, 212),
        (225, 248, 198),
        (38, 219, 5),
        (187, 1, 124),
        (236, 39, 251),
        (210, 45, 96),
        (17, 159, 102),
        (30, 20, 161),
        (159, 65, 190),
        (214, 84, 156),
        (139, 254, 159),
        (156, 226, 47),
        (220, 79, 71),
        (2, 160, 153),
        (93, 201, 162),
        (88, 73, 98),
        (11, 208, 213),
        (218, 201, 121),
        (251, 183, 254),
        (130, 112, 178),
        (222, 130, 106),
        (3, 101, 161),
        (1, 34, 102),
        (182, 223, 209),
        (37, 226, 149),
        (31, 108, 98),
        (221, 23, 143),
        (57, 216, 192),
    )
)

# ADE20K classes
ade20k_classes = {
    0: "wall",
    1: "building",
    2: "sky",
    3: "floor",
    4: "tree",
    5: "ceiling",
    6: "road",
    7: "bed",
    8: "windowpane",
    9: "grass",
    10: "cabinet",
    11: "sidewalk",
    12: "person",
    13: "earth",
    14: "door",
    15: "table",
    16: "mountain",
    17: "plant",
    18: "curtain",
    19: "chair",
    20: "car",
    21: "water",
    22: "painting",
    23: "sofa",
    24: "shelf",
    25: "house",
    26: "sea",
    27: "mirror",
    28: "rug",
    29: "field",
    30: "armchair",
    31: "seat",
    32: "fence",
    33: "desk",
    34: "rock",
    35: "wardrobe",
    36: "lamp",
    37: "bathtub",
    38: "railing",
    39: "cushion",
    40: "base",
    41: "box",
    42: "column",
    43: "signboard",
    44: "chest of drawers",
    45: "counter",
    46: "sand",
    47: "sink",
    48: "skyscraper",
    49: "fireplace",
    50: "refrigerator",
    51: "grandstand",
    52: "path",
    53: "stairs",
    54: "runway",
    55: "case",
    56: "pool table",
    57: "pillow",
    58: "screen door",
    59: "stairway",
    60: "river",
    61: "bridge",
    62: "bookcase",
    63: "blind",
    64: "coffee table",
    65: "toilet",
    66: "flower",
    67: "book",
    68: "hill",
    69: "bench",
    70: "countertop",
    71: "stove",
    72: "palm",
    73: "kitchen island",
    74: "computer",
    75: "swivel chair",
    76: "boat",
    77: "bar",
    78: "arcade machine",
    79: "hovel",
    80: "bus",
    81: "towel",
    82: "light",
    83: "truck",
    84: "tower",
    85: "chandelier",
    86: "awning",
    87: "streetlight",
    88: "booth",
    89: "television receiver",
    90: "airplane",
    91: "dirt track",
    92: "apparel",
    93: "pole",
    94: "land",
    95: "bannister",
    96: "escalator",
    97: "ottoman",
    98: "bottle",
    99: "buffet",
    100: "poster",
    101: "stage",
    102: "van",
    103: "ship",
    104: "fountain",
    105: "conveyer belt",
    106: "canopy",
    107: "washer",
    108: "plaything",
    109: "swimming pool",
    110: "stool",
    111: "barrel",
    112: "basket",
    113: "waterfall",
    114: "tent",
    115: "bag",
    116: "minibike",
    117: "cradle",
    118: "oven",
    119: "ball",
    120: "food",
    121: "step",
    122: "tank",
    123: "trade name",
    124: "microwave",
    125: "pot",
    126: "animal",
    127: "bicycle",
    128: "lake",
    129: "dishwasher",
    130: "screen",
    131: "blanket",
    132: "sculpture",
    133: "hood",
    134: "sconce",
    135: "vase",
    136: "traffic light",
    137: "tray",
    138: "ashcan",
    139: "fan",
    140: "pier",
    141: "crt screen",
    142: "plate",
    143: "monitor",
    144: "bulletin board",
    145: "shower",
    146: "radiator",
    147: "glass",
    148: "clock",
    149: "flag",
    150: "void",
}


def createKITTI360Lookup(kitti_360_labels):
    lookup = {}
    special_cases = {
        "tree": "vegetation",
        "plant": "vegetation",
        "grass": "terrain",
        "streetlight": ["pole", "lamp"],
        "signboard": "traffic sign",
    }
    for entry in kitti_360_labels:
        kitti_360_label, kitti_360_id, *_ = entry
        lookup[kitti_360_label] = kitti_360_id

    for ade20k_label, kitti_360_label in special_cases.items():
        if isinstance(kitti_360_label, list):
            for label in kitti_360_label:
                if label in lookup:
                    lookup[ade20k_label] = lookup[label]
        elif kitti_360_label in lookup:
            lookup[ade20k_label] = lookup[kitti_360_label]

    return lookup


kitti360_lookup = createKITTI360Lookup(kitti_360_labels)


def ade20k2kitti360(ade20k_id: int) -> int:
    label = ade20k_classes[ade20k_id]
    return kitti360_lookup.get(label, 255)


class_color_mapping = [
    (class_id, class_name, tuple(reversed(instanceColors[class_id])))
    for class_id, class_name in ade20k_classes.items()
]

class_color_mapping_kitti_360 = [
    (class_id, class_name, tuple(kitti_360_labels[class_id][-1]))
    for class_name, class_id in kitti360_lookup.items()
    if class_id >= 0
]

with open("class_colors_mapping.pkl", "wb") as f:
    pickle.dump(class_color_mapping, f)

with open("class_colors_mapping_kitti.pkl", "wb") as f:
    pickle.dump(class_color_mapping_kitti_360, f)

if __name__ == "__main__":
    print("ADE20K ---> KITTI360")
    for i in range(151):
        kitti_360_id, kitti_360_color = ade20k2kitti360(i)
        print(f"{i}: {ade20k_classes[i]} ---> {kitti_360_id}: {kitti_360_color}")
